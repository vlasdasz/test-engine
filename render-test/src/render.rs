use anyhow::Result;
use log::debug;
use test_engine::{
    App, RenderPass, from_main,
    ui::{UI, ViewCallbacks, view},
    ui_test::check_colors,
};

use crate::{occlusion::render_occlusion, path::render_path, render::Case::*};

#[derive(Default)]
enum Case {
    #[default]
    Occlusion,
    Path,
}

#[view]
struct RenderTestView {
    case: Case,
}

impl ViewCallbacks for RenderTestView {
    fn before_render(&self, pass: &mut RenderPass) {
        match self.case {
            Occlusion => {
                render_occlusion(pass);
            }
            Path => {
                render_path(pass);
            }
        }
    }
}

pub async fn test_render() -> Result<()> {
    debug!("Test render");

    let mut view = UI::init_test_view::<RenderTestView>().await;

    App::set_window_size((1000, 1000)).await;

    check_colors(
        r#"
              55  693 -  25  51  76
              79  704 -  25  51  76
              94  726 -  25  51  76
             106  734 - 255   0   0
             120  746 - 255   0   0
             128  753 - 255   0   0
             151  763 -   0 255   0
             170  773 -   0 255   0
             170  775 -   0 255   0
             188  801 -   0 255   0
             218  826 -   0   0 203
             238  843 -   0   0 203
             283  875 -   0   0 203
             306  888 -  25  51  76
             340  906 -  25  51  76
             363  921 -  25  51  76
             324  583 -  25  51  76
             306  572 -  25  51  76
             273  561 -   0   0 203
             259  554 -   0   0 203
             254  549 -   0   0 203
             235  532 -   0   0 203
             232  529 -   0   0 203
             223  521 -   0   0 203
             214  514 -   0   0 203
             195  496 -   0 255   0
             190  489 -   0 255   0
             173  472 -   0 255   0
             160  460 -   0 255   0
             123  423 - 255   0   0
             124  423 - 255   0   0
              95  392 -  25  51  76
              93  389 -  25  51  76
              74   88 -  25  51  76
              77   93 -  25  51  76
              89  107 -  25  51  76
             111  121 - 255   0   0
             140  137 - 255   0   0
             143  140 - 255   0   0
             168  162 - 255   0   0
             187  181 - 255   0   0
             209  203 -   0 255   0
             223  226 -   0 255   0
             241  248 -   0 255   0
             243  249 -   0 255   0
             263  262 -   0   0 203
             298  297 -   0   0 203
             302  302 -  25  51  76
             348  229 -  25  51  76
             373  221 -  25  51  76
             443  213 -   0 255   0
             467  212 -   0 255   0
             497  216 -  14  14  14
             557  217 -   0 255   0
             629  219 -  25  51  76
             672  210 -  25  51  76
             666  150 -  25  51  76
             615  161 -  25  51  76
             538  165 -  14  14  14
             497  177 -   0 255   0
             375  160 -  25  51  76
             379  133 -  25  51  76
             393   83 -  25  51  76
             473   66 -  25  51  76
             488   92 -  25  51  76
             507  182 -   0 255   0
             523  278 -   0 255   0
             519  391 -  25  51  76
             179   66 -  25  51  76
             188  109 - 255   0   0
             219  244 -   0 255   0
             221  329 -  25  51  76
             205  398 -  25  51  76
             206  451 -   0 255   0
             192  582 -  25  51  76
             193  632 -  25  51  76
             234  748 -  25  51  76
             238  852 -   0   0 203
             226  913 -  25  51  76
             223  948 -  25  51  76
        "#,
    )
    .await?;

    debug!("Occlusion: OK");

    from_main(move || {
        view.case = Path;
    })
    .await;

    check_colors(
        r#"
              94  134 -  25  51  76
             109  129 -   0   0 203
             111  129 -   0   0 203
             116  129 -   0   0 203
             131  127 -  25  51  76
             196  102 -  25  51  76
             164  110 -  25  51  76
             163  138 -   0   0 203
             164  141 -   0   0 203
             176  162 -  25  51  76
             176  184 -  25  51  76
             169  218 -  25  51  76
             142  216 -  25  51  76
             133  216 -  25  51  76
             115  206 -   0   0 203
             170  195 -  25  51  76
             125  177 -   0   0 203
              61  218 -  25  51  76
             122  182 -   0   0 203
             173  174 -  25  51  76
             225  241 -  25  51  76
        "#,
    )
    .await?;

    debug!("Path: OK");

    Ok(())
}
