use anyhow::Result;
use test_engine::{
    refs::Weak,
    ui::{
        Anchor, HasText, ImageView, Label, NumberView, Setup, UI, ViewData, ViewFrame, ViewSubviews,
        ui_test::{helpers::check_colors, inject_touches},
        view,
    },
};

#[view]
struct OutBounds {
    #[init]
    test: Label,
    x:    NumberView<f32>,
    y:    NumberView<f32>,
}

impl Setup for OutBounds {
    fn setup(mut self: Weak<Self>) {
        self.test.set_text("AA").set_text_size(100).set_frame((200, 200, 200, 200));

        let mut image = self.test.add_view::<ImageView>();
        image.set_image("cat.png");
        image.place().left_half();

        self.x.set_step(50.0);
        self.x
            .on_change(move |val| {
                self.test.set_x(200.0 + val);
            })
            .place()
            .size(60, 200)
            .center();

        self.y.set_step(50.0);
        self.y
            .on_change(move |val| {
                self.test.set_y(200.0 + val);
            })
            .place()
            .size(60, 200)
            .center_y()
            .anchor(Anchor::Left, self.x, 10);
    }
}

pub async fn test_out_bounds() -> Result<()> {
    UI::init_test_view::<OutBounds>().await;

    inject_touches(
        r"
            372  307  b
            371  307  e
            372  304  b
            372  304  e
            373  303  b
            373  303  e
            373  303  b
            373  303  e
            373  303  b
            373  303  e
            373  304  b
            373  304  e
        ",
    )
    .await;

    check_colors(
        r#"
             182  580 -  89 124 149
             206  580 - 231 185 188
             216  581 - 238 211 200
             247  578 - 207 175 150
             250  578 - 201 169 144
             262  579 - 184 153 132
             297  583 - 203 153 152
             298  582 - 203 153 152
             329  575 -   0   0   0
             332  573 - 255 255 255
             339  571 -   0   0   0
             358  570 - 255 255 255
             382  571 - 255 255 255
             407  569 -  89 124 149
             424  564 -  89 124 149
             428  527 -  89 124 149
             411  472 -  89 124 149
             358  477 -  89 124 149
             317  479 -  89 124 149
             295  523 - 216 166 167
             228  527 - 228 188 188
             224  466 -  89 124 149
             197  474 -  89 124 149
             174  545 -  89 124 149
             201  548 - 234 195 200
             224  524 - 230 190 191
        "#,
    )
    .await?;

    inject_touches(
        r"
            308  305  b
            308  305  e
            308  304  b
            308  304  e
            307  304  b
            307  304  e
            307  304  b
            307  304  e
            307  304  b
            307  304  e
            307  304  b
            307  304  e
            307  304  b
            307  304  e
        ",
    )
    .await;

    check_colors(
        r#"
             529  574 -  89 124 149
             555  575 - 229 189 190
             570  577 - 239 212 201
             581  577 - 213 185 161
             584  575 - 169 129 104
             585  564 - 222 194 180
             585  548 - 218 177 159
             585  537 - 210 168 156
             583  522 - 224 189 183
             572  485 -  89 124 149
             564  474 -  89 124 149
             514  519 -  89 124 149
             550  525 -  89 124 149
             572  525 - 230 190 191
        "#,
    )
    .await?;

    inject_touches(
        r"
            365  376  b
            365  376  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            365  377  b
            365  377  e
            299  376  b
            299  376  e
            299  375  b
            300  375  e
        ",
    )
    .await;

    check_colors(
        r#"
             418   70 -  89 124 149
             435   59 -  89 124 149
             445   51 -  89 124 149
             465   37 - 238 210 199
             487   30 - 204 168 146
             510   28 - 198 162 138
             532   26 - 172 141 120
             548   18 - 201 151 152
             556   12 - 255 255 255
             557   11 - 255 255 255
             565   11 -   0   0   0
             572   14 - 255 255 255
             577   21 - 255 255 255
             578   43 - 255 255 255
             577   71 - 255 255 255
             576   76 - 255 255 255
             568  104 -  89 124 149
             527  112 -  89 124 149
             504  103 -  89 124 149
             480   70 - 219 181 168
             439   32 -  89 124 149
             382   24 -  89 124 149
             343   25 -  89 124 149
        "#,
    )
    .await?;

    inject_touches(
        r"
            298  380  b
            298  380  e
            297  380  b
            297  380  e
            297  380  b
            297  380  e
            298  380  b
            298  380  e
            298  380  b
            298  380  e
            298  380  b
            298  380  e
            298  380  b
            298  380  e
            298  380  b
            298  380  e
            298  380  b
            298  380  e
            298  380  b
            298  380  e
        ",
    )
    .await;

    check_colors(
        r#"
             203   23 -  89 124 149
             182   13 -  89 124 149
             139    9 - 255 255 255
             123    9 - 255 255 255
             107    9 -   0   0   0
              90    8 - 255 255 255
              68    8 -   0   0   0
              57    8 - 255 255 255
              56    7 - 255 255 255
              65    5 -   0   0   0
              39   11 - 199 149 150
              35   27 - 172 144 122
              30   64 - 143 115  93
              29   88 - 161 131 107
              31  111 -  89 124 149
              71  118 -  89 124 149
             124   94 - 255 255 255
             160   80 -  89 124 149
        "#,
    )
    .await?;

    inject_touches(
        r"
            303  377  b
            303  377  e
            294  302  b
            294  302  e
            374  293  b
            374  293  e
            373  293  b
            372  293  e
            371  293  b
            372  293  e
            373  293  b
            373  293  e
            373  293  b
            373  293  e
            373  293  b
            373  293  e
        ",
    )
    .await;

    check_colors(
        r#"
              31  157 -  89 124 149
              29  179 -  89 124 149
              31  208 - 221 175 177
              23  233 - 219 173 173
              43  252 - 199 161 148
              57  261 - 255 255 255
              82  271 - 102 102 102
              84  271 - 255 255 255
             104  281 - 255 255 255
             129  294 - 255 255 255
             147  307 - 255 255 255
             186  333 -  89 124 149
             179  345 -  89 124 149
             157  350 -  89 124 149
              77  362 - 255 255 255
              58  364 - 255 255 255
              31  372 - 159 131 107
              22  386 - 158 126 105
              18  410 -  89 124 149
              54  414 -  89 124 149
             120  403 -  89 124 149
             145  374 - 255 255 255
             168  313 -  89 124 149
             145  218 - 255 255 255
              78  144 -  89 124 149
        "#,
    )
    .await?;

    inject_touches(
        r"
            372  364  b
            372  364  e
            381  275  b
            381  275  e
            378  293  b
            378  293  e
            378  293  b
            378  293  e
            378  293  b
            378  293  e
            378  293  b
            378  293  e
            378  292  b
            378  292  e
            378  292  b
            378  292  e
        ",
    )
    .await;

    check_colors(
        r#"
              36  477 -  89 124 149
              35  489 -  89 124 149
              23  524 - 222 176 176
              20  549 - 213 163 162
              26  559 - 186 144 120
              39  561 - 159 106  88
              54  562 - 255 255 255
              68  568 - 255 255 255
              81  571 -   0   0   0
              94  575 -   0   0   0
             104  576 - 255 255 255
             130  574 - 255 255 255
             158  561 -  89 124 149
             163  550 -  89 124 149
             156  537 -  89 124 149
             144  526 - 255 255 255
             127  504 - 255 255 255
             113  483 -  89 124 149
             102  470 -  89 124 149
              35  501 - 218 176 177
              24  556 - 216 165 164
        "#,
    )
    .await?;

    Ok(())
}
