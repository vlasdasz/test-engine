use anyhow::Result;
use log::debug;
use test_engine::{
    refs::Weak,
    ui::{Anchor::Left, Color, Container, ImageView, Setup, UI, ViewData, view},
    ui_test::check_colors,
};

#[view]
struct CornerRadiusTestView {
    #[init]
    square: Container,
    image:  ImageView,
    wide:   Container,
}

impl Setup for CornerRadiusTestView {
    fn setup(mut self: Weak<Self>) {
        self.square.set_color(Color::BLUE).set_corner_radius(50);
        self.square.place().size(100, 100).tl(50);

        self.image.set_image("cat.png").set_corner_radius(40);
        self.image.place().size(100, 200).t(50).anchor(Left, self.square, 20);

        self.wide.set_color(Color::YELLOW).set_corner_radius(20);
        self.wide.place().size(200, 100).t(50).anchor(Left, self.image, 20);
    }
}

pub async fn test_corner_radius() -> Result<()> {
    UI::init_test_view::<CornerRadiusTestView>().await;

    check_colors(
        r#"
              39   64 -  25  51  76
              53   67 -  25  51  76
              75   67 -   0   0 203
              91   67 -   0   0 203
             116   67 -   0   0 203
             132   67 -   0   0 203
             151   66 -  25  51  76
             153   66 -  25  51  76
             152   78 -  25  51  76
             156  108 -  25  51  76
             151  134 -  25  51  76
             141  148 -  25  51  76
             117  133 -   0   0 203
             112  128 -   0   0 203
             109  132 -   0   0 203
              95  152 -  25  51  76
              79  164 -  25  51  76
              73  152 -  25  51  76
              74  129 -   0   0 203
              76  117 -   0   0 203
              72  121 -   0   0 203
              44  137 -  25  51  76
              44  136 -  25  51  76
              60  119 -   0   0 203
              70   92 -   0   0 203
              60   90 -   0   0 203
              33  100 -  25  51  76
              33   94 -  25  51  76
              48   73 -  25  51  76
              54   39 -  25  51  76
              72   53 -  25  51  76
              79   71 -   0   0 203
              84   51 -  25  51  76
              89   31 -  25  51  76
              98   42 -  25  51  76
             102   67 -   0   0 203
             113   72 -   0   0 203
             135   60 -  25  51  76
             142   59 -  25  51  76
             142   73 -  25  51  76
             125   85 -   0   0 203
             138   80 -   0   0 203
             152   76 -  25  51  76
             154   76 -  25  51  76
             149   87 -  25  51  76
             126   95 -   0   0 203
             130  108 -   0   0 203
             142  139 -  25  51  76
             145  156 -  25  51  76
             121  142 -   0   0 203
             102  126 -   0   0 203
              87  150 -  25  51  76
              82  167 -  25  51  76
              70  142 -  25  51  76
              70  106 -   0   0 203
              64  140 -  25  51  76
              48  166 -  25  51  76
        "#,
    )
    .await?;

    check_colors(
        r#"
             173  246 -  25  51  76
             182  240 -  25  51  76
             190  231 - 205 139 126
             194  229 - 205 139 126
             193  227 - 207 145 131
             190  246 -  25  51  76
             210  258 -  25  51  76
             223  240 - 164 109  83
             224  231 - 160 106  81
             238  243 -  99  62  42
             249  252 -  25  51  76
             254  248 -  25  51  76
             244  232 -  52  29  19
             247  228 -  77  49  32
             266  232 -  25  51  76
             276  233 -  25  51  76
             262  215 -  97  62  39
             257  213 -  93  61  40
             271  205 -  25  51  76
             280  199 -  25  51  76
             265  194 -  92  60  42
             255  190 - 101  64  45
             274  184 -  25  51  76
             162   91 -  25  51  76
             177   87 - 207 135 137
             180   87 - 201 131 132
             174   78 - 209 139 147
             166   69 -  25  51  76
             160   60 -  25  51  76
             174   68 -  25  51  76
             181   74 - 199 129 142
             186   73 - 201 132 134
             175   44 -  25  51  76
             177   47 -  25  51  76
             192   64 - 203 134 135
             195   51 -  25  51  76
             201   34 -  25  51  76
             213   48 -  25  51  76
             222   64 - 188 117 120
             223   51 - 186 119 120
             240   40 -  25  51  76
             245   56 - 184 112 113
             242   71 - 186 110 110
             254   66 - 180 103 103
             267   51 -  25  51  76
             248   56 - 186 110 113
             245   72 - 182 107 110
             266   77 - 171  94  95
             274   86 -  25  51  76
             253   93 - 164  88  87
             254   95 - 167  87  87
        "#,
    )
    .await?;

    check_colors(
        r#"
             293  160 -  25  51  76
             301  144 - 255 255   0
             308  130 - 255 255   0
             309  131 - 255 255   0
             295  145 -  25  51  76
             286  155 -  25  51  76
             298  140 - 255 255   0
             303  133 - 255 255   0
             288  131 -  25  51  76
             280  131 -  25  51  76
             291  123 - 255 255   0
             304  111 - 255 255   0
             293   90 - 255 255   0
             284   66 -  25  51  76
             285   62 -  25  51  76
             299   67 - 255 255   0
             289   54 -  25  51  76
             283   46 -  25  51  76
             301   51 -  25  51  76
             309   56 - 255 255   0
             291   37 -  25  51  76
             305   55 - 255 255   0
             319   74 - 255 255   0
             294   33 -  25  51  76
             289   37 -  25  51  76
             329   56 - 255 255   0
             378   42 -  25  51  76
             390   36 -  25  51  76
             410   66 - 255 255   0
             465   43 -  25  51  76
             483   51 -  25  51  76
             467   64 - 255 255   0
             481   55 - 255 255   0
             500   47 -  25  51  76
             481   59 - 255 255   0
             476   60 - 255 255   0
             494   57 -  25  51  76
             497   57 -  25  51  76
             462   62 - 255 255   0
             473   44 -  25  51  76
             480   42 -  25  51  76
             490  111 -  25  51  76
             475  120 - 255 255   0
             490  134 -  25  51  76
             496  156 -  25  51  76
             481  150 -  25  51  76
             474  138 - 255 255   0
             473  133 - 255 255   0
             488  143 -  25  51  76
             497  148 -  25  51  76
             479  139 - 255 255   0
             469  125 - 255 255   0
             478  148 -  25  51  76
             479  161 -  25  51  76
             475  140 - 255 255   0
             474  131 - 255 255   0
             497  154 -  25  51  76
             481  148 -  25  51  76
             470  138 - 255 255   0
             467  130 - 255 255   0
             479  136 - 255 255   0
             485  141 - 255 255   0
             491  148 -  25  51  76
             492  149 -  25  51  76
             471  135 - 255 255   0
             474   96 - 255 255   0
             477   46 -  25  51  76
             478   41 -  25  51  76
             488   41 -  25  51  76
             493   44 -  25  51  76
             481   57 - 255 255   0
             478   62 - 255 255   0
        "#,
    )
    .await?;

    debug!("Corner radius test: OK");

    Ok(())
}
