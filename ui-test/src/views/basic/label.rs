use anyhow::Result;
use test_engine::{
    from_main,
    refs::Weak,
    ui::{Anchor, Color, HasText, Label, NumberView, Setup, TextAlignment, UI, ViewData, ViewSubviews, view},
    ui_test::{helpers::check_colors, inject_touches},
};

#[view]
struct LabelSettings {
    #[init]
    label:          Label,
    text_size_view: NumberView<f32>,
}

impl Setup for LabelSettings {
    fn setup(mut self: Weak<Self>) {
        self.label.set_text("ßšėčыў");
        self.label.place().back().size(280, 280).tl(80);

        self.text_size_view
            .place()
            .size(50, 50)
            .t(300)
            .anchor(Anchor::Right, self.label, 10);
        self.text_size_view.set_value(32.0).set_step(5.0);

        self.text_size_view.on_change(move |size| {
            self.label.set_text_size(size);
        });
    }
}

pub async fn test_label() -> Result<()> {
    let mut view = UI::init_test_view::<LabelSettings>().await;

    check_colors(
        r#"
              37  215 -  89 124 149
              50  213 -  89 124 149
              67  213 -  89 124 149
             109  215 - 255 255 255
             132  215 - 255 255 255
             155  217 - 255 255 255
             183  217 - 255 255 255
             187  217 -  53  53  53
             211  214 - 235 235 235
             213  214 -  39  39  39
             224  215 - 191 191 191
             235  218 - 255 255 255
             244  221 - 255 255 255
             257  224 - 255 255 255
             267  222 - 137 137 137
             271  212 -   0   0   0
             257  205 - 255 255 255
             245  210 - 255 255 255
             202  212 - 255 255 255
             201  205 - 255 255 255
             213  204 - 255 255 255
             236  210 - 255 255 255
             263  218 -  93  93  93
             276  215 - 255 255 255
             281  211 - 255 255 255
             247  201 - 255 255 255
             191  204 - 255 255 255
             176  205 - 190 190 190
             156  198 - 255 255 255
             180  186 - 255 255 255
             215  215 -   0   0   0
             241  222 - 255 255 255
             263  221 -   0   0   0
        "#,
    )
    .await?;

    inject_touches(
        "
            39   305  b
            39   305  e
            41   301  b
            42   301  e
            42   301  b
            42   301  e
            42   301  b
            42   301  e
            42   301  b
            42   301  e
            42   301  b
            42   301  e
            42   301  b
            42   301  e
            42   301  b
            42   301  e
            42   300  b
            42   300  e
            42   300  b
            42   300  e
            42   300  b
            42   300  e
            42   300  b
            42   300  e
            42   300  b
            42   300  e
            42   300  b
            42   300  e
            42   300  b
            42   300  e
            44   325  b
            44   325  e
            44   325  b
            44   325  e
            44   325  b
            44   325  e
            44   325  b
            44   325  e
            43   325  b
            43   325  e
            43   325  b
            43   325  e
            42   306  b
            43   308  e

        ",
    )
    .await;

    check_colors(
        r#"
              69  211 -  89 124 149
              70  211 -  89 124 149
              82  209 - 255 255 255
              99  195 - 255 255 255
             105  193 - 255 255 255
             134  190 - 255 255 255
             144  211 - 255 255 255
             159  215 - 255 255 255
             189  204 -   0   0   0
             195  195 - 255 255 255
             212  197 - 255 255 255
             248  204 -   0   0   0
             253  215 - 255 255 255
             291  223 -   0   0   0
             331  220 -  14  14  14
             361  215 -  89 124 149
             367  215 -  89 124 149
             374  217 -  89 124 149
             353  243 - 255 255 255
             323  236 - 255 255 255
             295  225 -  14  14  14
             248  225 - 255 255 255
             188  229 - 255 255 255
             143  230 - 255 255 255
              89  214 -  34  34  34
             101  193 - 255 255 255
             142  184 -  23  23  23
             187  219 -  14  14  14
             278  221 - 215 215 215
             307  208 -   0   0   0
             313  196 - 255 255 255
             334  199 - 255 255 255
             338  187 - 255 255 255
             328  175 - 255 255 255
             280  188 - 255 255 255
             223  200 - 255 255 255
             219  218 - 255 255 255
             221  233 - 255 255 255
        "#,
    )
    .await?;

    from_main(move || {
        view.label.set_text_color(Color::BLUE);
    })
    .await;

    check_colors(
        r#"
              66  202 -  89 124 149
              85  196 - 255 255 255
             121  191 - 208 208 247
             127  199 - 255 255 255
             145  222 - 224 224 249
             155  223 -   0   0 231
             161  208 -   0   0 231
             153  188 -  23  23 231
             152  191 -   0   0 231
             151  215 - 255 255 255
             223  220 -   0   0 231
             241  198 - 120 120 236
             262  202 - 255 255 255
             299  223 - 255 255 255
             316  225 - 255 255 255
             329  216 -  14  14 231
             331  215 -  14  14 231
             337  218 - 255 255 255
             337  225 - 255 255 255
             339  231 - 172 172 241
             340  213 - 255 255 255
             345  192 - 255 255 255
             339  189 -   0   0 231
             275  214 - 255 255 255
             135  222 - 255 255 255
        "#,
    )
    .await?;

    from_main(move || {
        view.label.set_text_size(28);
        view.add_view::<Label>()
            .set_text("Left Left")
            .set_alignment(TextAlignment::Left)
            .set_color(Color::LIGHTER_GRAY)
            .place()
            .tl(60)
            .w(200)
            .h(60);
        view.add_view::<Label>()
            .set_text("Right")
            .set_alignment(TextAlignment::Right)
            .set_color(Color::LIGHTER_GRAY)
            .place()
            .l(60)
            .w(200)
            .t(280)
            .h(60);
    })
    .await;

    check_colors(
        r#"
             266  310 - 255 255 255
             251  308 - 243 243 243
             244  310 - 243 243 243
             224  312 - 243 243 243
             217  312 - 243 243 243
             214  310 -   0   0   0
             209  308 - 243 243 243
             204  305 - 125 125 125
             199  304 - 243 243 243
             193  303 - 243 243 243
             191  303 - 243 243 243
             188  302 -   0   0   0
             182  300 - 243 243 243
             176  300 - 243 243 243
             173  300 -  13  13  13
             167  299 - 243 243 243
             160  299 - 243 243 243
             151  299 - 243 243 243
              41   78 -  89 124 149
              49   82 -  89 124 149
              56   83 -  89 124 149
              62   83 - 243 243 243
              71   83 - 243 243 243
              83   83 - 243 243 243
              86   83 - 243 243 243
             101   84 - 219 219 219
             134   88 - 243 243 243
             135   89 - 243 243 243
             149   89 - 243 243 243
             174   87 - 243 243 243
             177   86 -  13  13  13
             182   85 - 243 243 243
             188   85 - 216 216 216
             196   83 - 243 243 243
             209   81 - 243 243 243
             155  217 - 255 255 255
             173  209 - 255 255 255
             181  210 - 255 255 255
             182  211 - 255 255 255
             187  216 - 255 255 255
             199  217 - 252 252 254
             205  218 -  14  14 231
             213  218 - 255 255 255
             228  217 - 255 255 255
             231  217 - 112 112 235
             240  218 - 176 176 242
             249  219 -  77  77 233
             264  219 - 146 146 238
             271  217 - 255 255 255
             277  218 - 255 255 255
        "#,
    )
    .await?;

    Ok(())
}
