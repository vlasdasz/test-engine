use anyhow::Result;
use test_engine::{
    dispatch::from_main,
    refs::{Own, Weak},
    ui::{Container, GREEN, Point, PointView, Setup, UI, ViewData, ViewFrame, view},
    ui_test::{helpers::check_colors, inject_touches},
};

#[view]
struct StickView {
    vec: Own<Point>,

    #[init]
    test:  Container,
    stick: test_engine::ui::StickView,
    pos:   PointView,
}

impl Setup for StickView {
    fn setup(mut self: Weak<Self>) {
        self.test.set_color(GREEN).set_size(50, 50);

        self.stick.set_position((200, 200)).set_size(200, 200);

        self.stick.on_change.val(move |vec| {
            self.test.set_position(vec + 50);
            *self.vec += vec;
        });

        self.pos.set_multiplier(20).place().size(200, 200).bl(0);
        self.pos.changed.val(move |pos| {
            self.stick.set_position(pos);
        });
    }
}

pub async fn test_stick() -> Result<()> {
    let mut view = UI::init_test_view::<StickView>().await;

    check_colors(
        r#"
             174  253 -  89 124 149
             191  242 -  89 124 149
             196  242 -  89 124 149
             223  236 -   0   0   0
             254  238 - 255 255 255
             293  247 - 255 255 255
             355  251 - 255 255 255
             377  251 - 255 255 255
             420  249 -  89 124 149
             396  271 -  89 124 149
             359  277 - 255 255 255
             322  286 - 231 231 231
             278  291 - 231 231 231
             212  299 - 255 255 255
             190  307 -  89 124 149
             189  329 -  89 124 149
             198  349 -  89 124 149
             236  374 -   0   0   0
             284  396 -   0   0   0
             361  387 -  89 124 149
             356  334 - 255 255 255
             311  306 - 231 231 231
             301  301 - 231 231 231
             278  290 - 231 231 231
             275  273 - 231 231 231
             290  264 - 231 231 231
             297  257 - 231 231 231
             300  251 -   0   0   0
             308  206 - 255 255 255
             283  179 -  89 124 149
             198  189 -  89 124 149
             260  263 - 255 255 255
             311  321 - 231 231 231
             355  345 - 255 255 255
             416  370 -  89 124 149
             366  392 -  89 124 149
             284  395 -   0   0   0
             237  391 -  89 124 149
             221  379 -  89 124 149
             244  342 - 255 255 255
             320  282 - 231 231 231
             406  241 -  89 124 149
        "#,
    )
    .await?;

    inject_touches(
        r"
            126  352  m
            281  339  m
            367  325  m
            345  310  m
            336  300  b
            336  301  m
            375  351  m
            299  388  m
            180  244  m
            316  153  m
            396  292  m
            212  433  m
            85   166  m
            527  184  m
            187  508  m
            200  165  m
            522  205  m
            205  406  m
            213  167  m
            507  274  m
            212  454  m
            115  205  m
            491  225  m
            232  463  m
            82   213  m
            541  179  m
            264  471  m
            154  182  m
            642  147  m
            307  245  m
            570  210  m
            178  274  m
            361  296  m
            278  301  m
            235  308  m
            550  297  m
            338  309  m
            433  302  m
            374  183  m
            350  324  m
            286  317  m
            236  243  m
            261  253  m
            306  301  m
            342  333  e
            368  322  m
            459  293  m
            476  273  m
            476  272  b
            466  291  m
            440  310  m
            385  308  e
            384  308  m
            340  304  b
            340  304  m
            483  307  m
            516  308  m
            523  308  m
            494  308  e
            344  311  m
            289  292  m
            266  292  m
            293  293  b
            225  295  m
            21   263  m
            -37  251  m
            -8   248  e
            62   244  m
            98   233  m
            91   233  b
            101  236  m
            235  275  m
            321  309  m
            340  277  m
            389  253  m
            104  408  m
            283  321  m
            176  399  m
            213  352  e
            227  346  m
            259  331  m
            268  329  b
            267  330  m
            11   319  m
            123  308  e
            549  342  m
        ",
    )
    .await;

    assert_eq!(view.vec, Point::new(12.244_078, -26.364_265));

    from_main(move || {
        view.stick.set_position((400, 50));
    })
    .await;

    check_colors(
        r#"
             398  231 -  89 124 149
             412  230 -  89 124 149
             430  230 -  89 124 149
             469  219 - 255 255 255
             511  219 - 255 255 255
             533  219 - 255 255 255
             569  232 -  89 124 149
             575  233 -  89 124 149
             568  209 - 255 255 255
             559  181 - 255 255 255
             545  149 -   0   0   0
             534  140 - 231 231 231
             529  120 - 231 231 231
             541   73 - 255 255 255
             544   55 -  89 124 149
             543   41 -  89 124 149
             524   41 -  89 124 149
             471   48 -  89 124 149
             427   59 -  89 124 149
             411   87 -  89 124 149
             439  121 - 255 255 255
             485  147 - 231 231 231
             497  152 - 231 231 231
             457  179 - 255 255 255
             417  194 - 255 255 255
             386  217 -  89 124 149
             355  168 -  89 124 149
             362  103 -  89 124 149
             415   63 -  89 124 149
             497   30 -  89 124 149
             534   53 -  89 124 149
             553   88 - 255 255 255
             562  199 - 255 255 255
             564  229 -  89 124 149
        "#,
    )
    .await?;

    Ok(())
}
