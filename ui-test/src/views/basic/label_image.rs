use std::any::Any;

use anyhow::Result;
use test_engine::{
    dispatch::from_main,
    refs::Weak,
    ui::{
        Anchor::{Top, X},
        Container, HasText, LIGHT_BLUE, Label, Setup, TableData, TableView, UI, ViewData, ViewSubviews,
        WHITE, view,
    },
    ui_test::helpers::check_colors,
};

#[view]
struct LabelImage {
    resizing_image: bool,

    #[init]
    label:      Label,
    table_view: TableView,
    container:  Container,
}

impl Setup for LabelImage {
    fn setup(mut self: Weak<Self>) {
        self.label.set_text("ßšėčыў").set_text_size(110).set_image("cat.png");
        self.label.place().tl(50).w(400).h(200);

        self.table_view.set_data_source(self);
        self.table_view
            .place()
            .same([X], self.label)
            .anchor(Top, self.label, 40)
            .w(50)
            .h(200);
        self.table_view.set_color(LIGHT_BLUE);

        self.container.place().t(280).l(280).size(200, 200).all_ver();
        self.container.set_color(LIGHT_BLUE);

        self.container
            .add_view::<Label>()
            .set_text("test 1")
            .set_text_size(50)
            .set_text_color(WHITE)
            .set_image("cat.png");
        self.container
            .add_view::<Label>()
            .set_text("test 2")
            .set_text_size(50)
            .set_text_color(WHITE)
            .set_image("cat.png");
    }
}

impl TableData for LabelImage {
    fn cell_height(self: Weak<Self>) -> f32 {
        50.0
    }

    fn number_of_cells(self: Weak<Self>) -> usize {
        4
    }

    fn setup_cell(self: Weak<Self>, cell: &mut dyn Any, index: usize) {
        let label = cell.downcast_mut::<Label>().unwrap();

        label.set_text(index);
        label.set_text_size(50);
        label.set_text_color(WHITE);
        if self.resizing_image {
            label.set_resizing_image("button");
        } else {
            label.set_image("cat.png");
        }
    }
}

pub async fn test_label_image() -> Result<()> {
    let mut view = UI::init_test_view::<LabelImage>().await;

    check_colors(
        r#"
              36  154 -  89 124 149
              67  154 - 228 178 181
              74  154 - 130 100 102
              75  154 -   0   0   0
              79  153 -   0   0   0
              88  153 - 234 186 186
             102  153 - 239 210 204
             118  158 -   0   0   0
             138  158 - 233 200 183
             160  155 - 122 102  91
             173  155 -   0   0   0
             223  143 - 168 137 109
             247  143 - 182 151 122
             255  143 -   5   3   2
             257  143 -   5   3   2
             290  143 -  64  55  26
             310  149 -   2   1   1
             322  152 - 179 148 119
             372  153 -   6   4   2
             373  154 -   6   4   2
             393  154 - 200 150 149
             400  154 -   0   0   0
             422  154 -   0   0   0
             442  154 - 201 151 152
             420  110 -  36  25  19
             406  110 -   0   0   0
             217  113 -   0   0   0
             217  113 -   0   0   0
             217  113 -   0   0   0
             565  149 -  89 124 149
             322  174 -   7   5   3
        "#,
    )
    .await?;

    from_main(move || {
        view.label.set_resizing_image("button");
        view.label.set_text_color(WHITE);
    });

    check_colors(
        r#"
              42  158 -  89 124 149
              60  156 -   2  19  64
              71  154 -   4  18  61
              80  154 - 255 255 255
              91  154 -   4  18  63
             113  157 - 255 255 255
             127  157 -   4  19  64
             139  156 -   5  18  65
             155  157 -   5  18  65
             215  156 -   4  18  65
             237  156 -   4  18  64
             248  156 -   5  19  65
             270  156 -   4  19  65
             304  156 -   4  18  64
             315  156 - 255 255 255
             349  156 - 255 255 255
             361  155 -   5  19  65
             375  155 -   5  18  64
             381  155 -   5  18  65
             395  155 - 255 255 255
             416  153 - 255 255 255
             425  154 -   5  18  64
             441  154 -   5  18  61
             482  154 -  89 124 149
             426  223 -   3  17  63
             440  238 -  89 124 149
              66   32 -  89 124 149
              66   85 -   3  17  63
             110   90 -   4  17  64
        "#,
    )
    .await?;

    check_colors(
        r#"
              35  495 -  89 124 149
              47  491 -  89 124 149
              62  479 - 218 185 170
              71  462 - 187 162 143
              77  448 - 230 193 195
              78  438 - 202 170 149
              73  415 - 255 255 255
              73  404 - 207 183 159
              73  388 - 212 169 152
              73  377 - 206 174 151
              72  359 - 174 142 119
              72  345 - 226 186 186
              70  313 - 185 154 126
              70  307 - 204 176 152
              72  283 -  89 124 149
              74  277 -  89 124 149
              84  301 - 255 255 255
              81  327 - 211 183 166
              78  351 - 248 241 241
              74  368 - 249 246 245
              68  406 - 212 184 170
              75  429 - 209 174 152
              77  454 - 182 151 130
              86  459 - 173 145 121
              97  461 - 203 153 152
             264  464 -  89 124 149
             285  461 - 226 164 167
             303  452 - 240 212 201
             324  447 - 228 198 187
             358  440 - 220 180 170
             378  436 - 194 148 124
             385  434 - 181 147 112
             399  428 -  48  27   6
             420  420 - 196 178 166
             422  419 - 181 151 127
             422  419 - 181 151 127
             432  416 - 173 138 116
             448  390 - 214 164 163
             452  350 - 175 144 123
             446  315 - 170 125 104
             410  312 - 182 156 131
             352  315 - 212 185 168
             340  328 - 246 237 233
             309  326 - 236 209 200
             268  313 -  89 124 149
             265  311 -  89 124 149
             278  290 -  89 124 149
             293  274 -  89 124 149
             315  268 -  89 124 149
             364  288 - 229 189 189
             355  322 - 255 255 255
             434  355 - 131 105  88
             456  339 - 172 136 124
             489  319 -  89 124 149
             514  377 -  89 124 149
             455  422 - 203 153 152
             346  413 - 226 200 183
             367  456 - 210 178 155
             423  493 -  89 124 149
             505  439 -  89 124 149
             378  387 - 222 182 183
             347  429 - 255 255 255
             347  449 - 212 177 157
             246  381 -  89 124 149
             200  353 -  89 124 149
             274  332 -  89 124 149
             357  339 - 227 193 183
             406  314 - 184 156 132
             385  276 -  89 124 149
             470  277 -  89 124 149
             534  290 -  89 124 149
             514  355 -  89 124 149
             353  348 - 209 177 156
             364  430 - 162 121  93
             434  483 -  89 124 149
             447  415 - 156 105  86
             379  402 - 217 179 170
             429  440 - 255 255 255
             428  430 - 253 252 252
             427  418 - 176 146 122
             429  418 - 174 139 117
             435  422 - 255 255 255
             432  430 - 183 151 126
             433  430 - 181 149 124
        "#,
    )
    .await?;

    from_main(move || {
        view.resizing_image = true;
        view.table_view.reload_data();
    });

    check_colors(
        r#"
              35  503 -  89 124 149
              48  497 -  89 124 149
              56  488 -   0 218 255
              72  471 -   4  19  66
              78  461 - 255 255 255
              82  452 - 255 255 255
              99  436 -   0 218 255
             111  423 -  89 124 149
             111  419 -  89 124 149
              90  417 -   3  16  63
              70  406 -   5  20  65
              57  394 -   0 218 255
              48  389 -  89 124 149
              48  389 -  89 124 149
              56  382 -   0  55 161
              79  365 -   3  16  63
              89  359 -   4  17  63
             111  347 -  89 124 149
             122  337 -  89 124 149
              99  333 -   0 218 255
              60  310 -   5  18  65
              44  297 -  89 124 149
              48  286 -  89 124 149
              78  277 -  89 124 149
              84  295 -   1  20  67
              66  328 -   4  18  64
              75  375 - 254 254 254
              76  401 -   4  18  65
              78  442 -   7   8  33
              76  464 -   4  18  63
             118  449 -  89 124 149
             116  420 -  89 124 149
        "#,
    )
    .await?;

    Ok(())
}
