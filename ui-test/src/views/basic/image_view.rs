use anyhow::Result;
use test_engine::{
    from_main,
    refs::Weak,
    ui::{Setup, UI, ViewData, ViewTouch, view},
    ui_test::helpers::check_colors,
};

#[view]
struct ImageView {
    #[init]
    image_view: test_engine::ui::ImageView,
}

impl Setup for ImageView {
    fn setup(mut self: Weak<Self>) {
        self.enable_touch();

        self.image_view.place().tl(100).size(280, 280);
        self.image_view.set_image("gradient.png");
    }
}

pub async fn test_image_view() -> Result<()> {
    let view = UI::init_test_view::<ImageView>().await;

    check_colors(
        r#"
              69  108 -  89 124 149
              82  108 -  89 124 149
             113  104 - 111 238  73
             127  103 - 105 226  72
             142  102 -  98 213  73
             166  102 -  88 191  79
             234  102 -  58 131 121
             319  104 -  22  55 188
             334  104 -  17  42 202
             357  104 -   9  22 222
             389  105 -  89 124 149
             406  114 -  89 124 149
             394  154 -  89 124 149
             370  172 -  67  67 176
             373  210 - 102 102 147
             369  253 - 140 140 113
             378  307 - 189 189  86
             376  342 - 221 221  79
             369  375 - 249 245  81
             351  395 -  89 124 149
             314  382 -  89 124 149
             283  368 - 233 171  60
             272  367 - 231 162  58
             257  367 - 229 148  54
             221  368 - 228 119  47
             143  375 - 230  65  37
             128  375 - 230  58  36
             117  362 - 218  52  36
             104  352 - 209  54  32
              98  308 -  89 124 149
              99  269 -  89 124 149
             107  239 - 127 128  39
             108  203 - 110 159  47
             108  185 - 105 175  52
             107  122 - 109 230  70
             136  182 -  89 124 149
             231  224 -  89 124 149
             153  238 -  89 124 149
              79  244 -  89 124 149
              53  258 -  89 124 149
             161  288 -  89 124 149
             348  290 -  89 124 149
             455  264 -  89 124 149
             467  165 -  89 124 149
             320   57 -  89 124 149
             214  101 -  67 149 107
             165  212 -  89 124 149
              45  241 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        view.image_view.place().clear().tl(100).size(400, 400);
    })
    .await;

    check_colors(
        r#"
              65  113 -  89 124 149
              89  103 -  89 124 149
             117  104 - 111 239  74
             160  103 -  98 213  73
             194  103 -  88 191  79
             241  102 -  73 162  96
             364  104 -  36  86 160
             371  104 -  34  81 165
             422  111 -  21  49 193
             465  111 -  12  23 219
             536  120 -  89 124 149
             545  128 -  89 124 149
             515  152 -  89 124 149
             489  187 -  57  57 187
             481  246 -  94  94 151
             488  381 - 179 179  89
             490  453 - 226 226  79
             486  497 - 251 246  82
             470  543 -  89 124 149
             456  530 -  89 124 149
             424  487 - 240 208  70
             360  479 - 230 170  60
             270  478 - 224 117  47
             178  484 - 225  70  38
             135  486 - 226  56  36
              88  482 -  89 124 149
              79  467 -  89 124 149
              97  444 -  89 124 149
             127  431 -  89 124 149
             131  387 -  89 124 149
             124  283 - 121 137  43
             115  229 - 106 171  51
             115  191 - 102 194  58
             108  148 - 106 221  66
              95  255 -  89 124 149
             102  386 - 169  80  30
             283  337 -  89 124 149
             371  272 -  89 124 149
        "#,
    )
    .await?;

    Ok(())
}
