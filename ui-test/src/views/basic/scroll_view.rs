use anyhow::Result;
use test_engine::{
    dispatch::from_main,
    refs::Weak,
    ui::{ScrollView, Setup, TURQUOISE, UI, ViewData, view},
    ui_test::{
        helpers::{add_corners, check_colors},
        inject_scroll, inject_touches,
    },
};

#[view]
struct Scrolling {
    #[init]
    scroll: ScrollView,
}

impl Setup for Scrolling {
    fn setup(mut self: Weak<Self>) {
        self.scroll.set_content_size((600, 600));
        self.scroll.place().back();
        add_corners(self.scroll, TURQUOISE);
    }
}

pub async fn test_scroll_view() -> Result<()> {
    let mut view = UI::init_test_view::<Scrolling>();

    check_colors(
        r#"
              51  117 -  89 124 149
              50  120 -  89 124 149
              55  100 -  89 124 149
              64   82 -   0 255 255
              72   67 -   0 255 255
              86   61 -   0 255 255
             112   55 -  89 124 149
             127   54 -  89 124 149
             464   66 -  89 124 149
             499   63 -  89 124 149
             501   63 -   0 255 255
             548   67 -   0 255 255
             555   77 -   0 255 255
             559   97 -   0 255 255
             562  109 -  89 124 149
              48  468 -  89 124 149
              51  480 -  89 124 149
              54  508 -   0 255 255
              64  522 -   0 255 255
              86  529 -   0 255 255
             100  533 -  89 124 149
             107  535 -  89 124 149
             465  539 -  89 124 149
             495  536 -  89 124 149
             504  536 -   0 255 255
             520  538 -   0 255 255
             532  533 -   0 255 255
             542  518 -   0 255 255
             552  476 -  89 124 149
        "#,
    )?;

    assert_eq!(view.scroll.content_offset(), 0.0);

    inject_scroll(-5);
    assert_eq!(view.scroll.content_offset(), -0.0);

    inject_scroll(-20);
    assert_eq!(view.scroll.content_offset(), -0.0);

    inject_scroll(-30);
    assert_eq!(view.scroll.content_offset(), -0.0);

    check_colors(
        r#"
              51  117 -  89 124 149
              50  120 -  89 124 149
              55  100 -  89 124 149
              64   82 -   0 255 255
              72   67 -   0 255 255
              86   61 -   0 255 255
             112   55 -  89 124 149
             127   54 -  89 124 149
             464   66 -  89 124 149
             499   63 -  89 124 149
             501   63 -   0 255 255
             548   67 -   0 255 255
             555   77 -   0 255 255
             559   97 -   0 255 255
             562  109 -  89 124 149
              48  468 -  89 124 149
              51  480 -  89 124 149
              54  508 -   0 255 255
              64  522 -   0 255 255
              86  529 -   0 255 255
             100  533 -  89 124 149
             107  535 -  89 124 149
             465  539 -  89 124 149
             495  536 -  89 124 149
             504  536 -   0 255 255
             520  538 -   0 255 255
             532  533 -   0 255 255
             542  518 -   0 255 255
             552  476 -  89 124 149
        "#,
    )?;

    from_main(move || {
        view.scroll.set_content_size((400, 400));
    });

    check_colors(
        r#"
              71  115 -  89 124 149
              71  100 -  89 124 149
              76   91 -   0 255 255
              92   67 -   0 255 255
             154   54 -  89 124 149
             219   52 -  89 124 149
             255   49 -  89 124 149
             285   46 -  89 124 149
             354   44 -   0 255 255
             405   49 -  89 124 149
             451   57 -  89 124 149
             396   64 -   0 255 255
             385   64 -   0 255 255
             354   82 -   0 255 255
             350  116 -  89 124 149
             342  206 -  89 124 149
             347  282 -  89 124 149
             356  336 -   0 255 255
             370  415 -  89 124 149
             407  430 -  89 124 149
             422  388 -  89 124 149
             420  366 -  89 124 149
             396  348 -   0 255 255
             361  344 -   0 255 255
             309  346 -   0 255 255
             269  348 -  89 124 149
             167  353 -  89 124 149
             103  359 -  89 124 149
              66  360 -   0 255 255
              50  345 -   0 255 255
              15  279 -  89 124 149
              18  226 -  89 124 149
              44  273 -  89 124 149
              47  307 -   0 255 255
              46  340 -   0 255 255
              48  392 -   0 255 255
              53  434 -  89 124 149
        "#,
    )?;

    from_main(move || {
        view.scroll.set_content_size((600, 800));
    });

    check_colors(
        r#"
             549  127 -  89 124 149
             545  119 -  89 124 149
             542  111 -  89 124 149
             539  102 -  89 124 149
             535   82 -   0 255 255
             529   66 -   0 255 255
             518   54 -   0 255 255
             502   47 -   0 255 255
             487   42 -  89 124 149
             485   43 -  89 124 149
             471   48 -  89 124 149
             415   58 -  89 124 149
             129   52 -  89 124 149
              99   50 -   0 255 255
              93   52 -   0 255 255
              38   58 -   0 255 255
              38   89 -   0 255 255
              40  100 -  89 124 149
              42  179 -  89 124 149
              58  291 -  89 124 149
              46  427 -  89 124 149
              36  524 -  89 124 149
              46  546 -  89 124 149
              89  550 -  89 124 149
             183  553 -  89 124 149
             342  541 -  89 124 149
             457  539 -  89 124 149
             560  548 -  89 124 149
             567  535 -  89 124 149
             581  437 -  89 124 149
             519  338 -  89 124 149
             306  443 -  89 124 149
             206  297 -  89 124 149
             324  205 -  89 124 149
             473  211 -  89 124 149
             510  166 -  89 124 149
             337  116 -  89 124 149
             193   50 -  89 124 149
        "#,
    )?;

    inject_scroll(-150);
    assert_eq!(view.scroll.content_offset(), -150.0);

    check_colors(
        r#"
              70  493 -  89 124 149
              71  508 -  89 124 149
              64  523 -  89 124 149
              62  536 -  89 124 149
              61  553 -   0 255 255
              61  561 -   0 255 255
              83  566 -   0 255 255
             105  569 -  89 124 149
             143  571 -  89 124 149
             216  573 -  89 124 149
             359  572 -  89 124 149
             462  572 -  89 124 149
             477  572 -  89 124 149
             515  572 -   0 255 255
             545  568 -   0 255 255
             548  547 -  89 124 149
             543  524 -  89 124 149
             538  511 -  89 124 149
             530  499 -  89 124 149
             512  423 -  89 124 149
             503  379 -  89 124 149
             505  311 -  89 124 149
             508  232 -  89 124 149
             514  136 -  89 124 149
             519   80 -  89 124 149
             518   57 -  89 124 149
             480   34 -  89 124 149
             293   28 -  89 124 149
             227   32 -  89 124 149
             117   35 -  89 124 149
              57   35 -  89 124 149
              55   49 -  89 124 149
              31  230 -  89 124 149
              50  336 -  89 124 149
              86  431 -  89 124 149
             318  403 -  89 124 149
             399  282 -  89 124 149
             214  178 -  89 124 149
        "#,
    )?;

    inject_scroll(-1500);
    assert_eq!(view.scroll.content_offset(), -200.0);

    check_colors(
        r#"
              62  448 -  89 124 149
              60  475 -  89 124 149
              54  504 -   0 255 255
              57  534 -   0 255 255
              68  552 -   0 255 255
             100  556 -  89 124 149
             119  553 -  89 124 149
             238  541 -  89 124 149
             359  530 -  89 124 149
             423  525 -  89 124 149
             472  527 -  89 124 149
             534  529 -   0 255 255
             548  523 -   0 255 255
             553  502 -   0 255 255
             552  480 -  89 124 149
             565  371 -  89 124 149
             563  231 -  89 124 149
             553  162 -  89 124 149
             545   52 -  89 124 149
             535   40 -  89 124 149
             496   28 -  89 124 149
             366   34 -  89 124 149
             146   36 -  89 124 149
             132   49 -  89 124 149
              73  175 -  89 124 149
              64  284 -  89 124 149
              85  474 -  89 124 149
             321  299 -  89 124 149
             253  164 -  89 124 149
             323  271 -  89 124 149
             376  264 -  89 124 149
        "#,
    )?;

    inject_touches(
        "
            556  565  m
            559  565  m
            582  572  m
            590  576  m
            586  578  m
            584  579  m
            578  577  m
            573  574  m
            561  568  m
            551  554  m
            540  540  m
            558  553  m
            572  566  m
            574  567  m
            574  567  b
            577  540  m
            584  455  m
            586  340  m
            587  207  m
            580  52   m
            577  14   m
            576  0    m
            565  146  m
            552  299  m
            543  450  m
            538  577  m
            539  658  m
            560  593  m
            577  388  m
            596  158  m
            597  38   m
            595  -9   m
            592  4    m
            590  266  m
            587  509  m
            584  636  m
            585  659  m
            594  570  m
            606  307  m
            603  135  m
            599  45   m
            595  3    m
            594  -8   m
            592  -22  m
            589  -21  e
            581  4    m
            538  81   m
            519  100  m
            516  111  m
        ",
    );

    check_colors(
        r#"
             524  185 -  89 124 149
             533  160 -  89 124 149
             530  139 -  89 124 149
             530  126 -  89 124 149
             530  105 -  89 124 149
             523   80 -   0 255 255
             509   58 -   0 255 255
             498   57 -  89 124 149
             475   57 -  89 124 149
             432   57 -  89 124 149
             332   54 -  89 124 149
             200   55 -  89 124 149
             160   55 -  89 124 149
             111   63 -  89 124 149
              62   67 -   0 255 255
              61   80 -   0 255 255
              60  110 -  89 124 149
              59  119 -  89 124 149
              66  109 -  89 124 149
              94   60 -   0 255 255
             174   49 -  89 124 149
              54   79 -   0 255 255
              56  135 -  89 124 149
              69  228 -  89 124 149
              76  343 -  89 124 149
              86  476 -  89 124 149
             134  500 -  89 124 149
             360  523 -  89 124 149
             462  512 -  89 124 149
             507  455 -  89 124 149
             537  327 -  89 124 149
             455  197 -  89 124 149
             291  294 -  89 124 149
             164  315 -  89 124 149
             326  117 -  89 124 149
             366  145 -  89 124 149
        "#,
    )?;

    from_main(move || {
        view.scroll.set_content_offset(-400.0);
    });

    check_colors(
        r#"
              79  442 -  89 124 149
              74  480 -  89 124 149
              67  501 -   0 255 255
              60  529 -   0 255 255
              76  536 -   0 255 255
             116  538 -  89 124 149
             175  538 -  89 124 149
             342  543 -  89 124 149
             432  542 -  89 124 149
             488  541 -  89 124 149
             523  537 -   0 255 255
             547  534 -   0 255 255
             555  489 -  89 124 149
             550  477 -  89 124 149
             527  480 -  89 124 149
             485  512 -  89 124 149
             457  541 -  89 124 149
             447  460 -  89 124 149
             493  405 -  89 124 149
             519  311 -  89 124 149
             515  191 -  89 124 149
             477   82 -  89 124 149
             360   24 -  89 124 149
             263   25 -  89 124 149
             138   45 -  89 124 149
              97  182 -  89 124 149
             114  344 -  89 124 149
             306  363 -  89 124 149
             388  511 -  89 124 149
             182  499 -  89 124 149
              29  526 -   0 255 255
        "#,
    )?;

    Ok(())
}
