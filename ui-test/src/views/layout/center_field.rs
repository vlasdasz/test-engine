use test_engine::{
    dispatch::from_main,
    refs::Weak,
    ui::{Anchor::CenterY, BLUE, Container, GREEN, Setup, UI, ViewData, ViewSubviews, view},
    ui_test::check_colors,
};

#[view]
struct CenterField {
    field: Weak<Container>,

    #[init]
    container: Container,
}

impl Setup for CenterField {
    fn setup(mut self: Weak<Self>) {
        self.container.set_color(GREEN);
        self.container.place().all_sides(100);

        self.field = self.container.add_view();

        self.field.set_color(BLUE);
        self.field.place().lr(20).h(68);
    }
}

pub async fn test_center_field() -> anyhow::Result<()> {
    let view = UI::init_test_view::<CenterField>();

    check_colors(
        r#"
              70  132 -  89 124 149
              85  130 -  89 124 149
             109  127 -   0 255   0
             113  128 -   0 255   0
             124  126 -   0   0 231
             177  123 -   0   0 231
             196  124 -   0   0 231
             265  126 -   0   0 231
             322  128 -   0   0 231
             377  124 -   0   0 231
             417  127 -   0   0 231
             453  130 -   0   0 231
             515  136 -  89 124 149
             516  136 -  89 124 149
             524  185 -  89 124 149
             428  225 -   0 255   0
             347  209 -   0 255   0
             329  176 -   0 255   0
             323  152 -   0   0 231
             309   91 -  89 124 149
             296   50 -  89 124 149
             218   90 -  89 124 149
             220  167 -   0   0 231
        "#,
    )?;

    from_main(move || {
        view.container.place().clear().all_sides(200);
    });

    check_colors(
        r#"
             161  229 -  89 124 149
             178  224 -  89 124 149
             194  221 -  89 124 149
             218  218 -   0 255   0
             235  222 -   0   0 231
             260  227 -   0   0 231
             300  227 -   0   0 231
             347  231 -   0   0 231
             366  231 -   0   0 231
             409  235 -  89 124 149
             435  247 -  89 124 149
             427  279 -  89 124 149
             328  326 -   0 255   0
             282  367 -   0 255   0
             282  423 -  89 124 149
             166  406 -  89 124 149
             197  326 -  89 124 149
             287  307 -   0 255   0
             284  239 -   0   0 231
             288  186 -  89 124 149
             290  163 -  89 124 149
             291  162 -  89 124 149
        "#,
    )?;

    from_main(move || {
        view.container.place().clear().all_sides(250);
        view.field.place().max_width(200);
    });

    check_colors(
        r#"
             218  282 -  89 124 149
             231  281 -  89 124 149
             246  281 -  89 124 149
             260  279 -   0 255   0
             296  279 -   0   0 231
             312  279 -   0   0 231
             336  276 -   0 255   0
             349  276 -   0 255   0
             380  283 -  89 124 149
             389  342 -  89 124 149
             363  377 -  89 124 149
             316  379 -  89 124 149
             281  354 -  89 124 149
             283  340 -   0 255   0
             290  315 -   0   0 231
             293  300 -   0   0 231
             298  271 -   0   0 231
             301  257 -   0   0 231
             303  230 -  89 124 149
             305  222 -  89 124 149
             302  268 -   0   0 231
             265  292 -   0 255   0
             241  292 -  89 124 149
        "#,
    )?;

    from_main(move || {
        view.container.place().clear().all_sides(100);
    });

    check_colors(
        r#"
              55  133 -  89 124 149
              67  128 -  89 124 149
             102  124 -   0 255   0
             132  122 -   0   0 231
             166  119 -   0   0 231
             198  121 -   0   0 231
             268  130 -   0   0 231
             295  130 -   0   0 231
             349  132 -   0 255   0
             366  133 -   0 255   0
             466  143 -   0 255   0
             554  156 -  89 124 149
             563  178 -  89 124 149
             460  241 -   0 255   0
             279  247 -   0 255   0
             204  202 -   0 255   0
             203  179 -   0 255   0
             209  142 -   0   0 231
             218   82 -  89 124 149
             219   56 -  89 124 149
             221   38 -  89 124 149
             221  107 -   0   0 231
             224  193 -   0 255   0
             212  326 -   0 255   0
              88  414 -  89 124 149
              68  416 -  89 124 149
        "#,
    )?;

    from_main(move || {
        view.field.place().center_x();
    });

    check_colors(
        r#"
              67  135 -  89 124 149
              95  131 -  89 124 149
             135  135 -   0 255   0
             184  134 -   0 255   0
             245  132 -   0   0 231
             276  132 -   0   0 231
             353  134 -   0   0 231
             447  140 -   0 255   0
             521  149 -  89 124 149
             535  140 -  89 124 149
             526   97 -  89 124 149
             477   55 -  89 124 149
             426   40 -  89 124 149
             371   58 -  89 124 149
             342   93 -  89 124 149
             322  134 -   0   0 231
             307  193 -   0 255   0
             303  209 -   0 255   0
        "#,
    )?;

    from_main(move || {
        view.field.place().relative(CenterY, view.container, -50.0);
    });

    check_colors(
        r#"
              70  245 -  89 124 149
              83  243 -  89 124 149
             103  241 -   0 255   0
             144  238 -   0 255   0
             158  237 -   0 255   0
             193  237 -   0 255   0
             244  240 -   0   0 231
             254  241 -   0   0 231
             317  244 -   0   0 231
             379  246 -   0   0 231
             465  242 -   0 255   0
             532  243 -  89 124 149
             578  248 -  89 124 149
             546  243 -  89 124 149
             369  245 -   0   0 231
             342  239 -   0   0 231
             325  227 -   0   0 231
             312  163 -   0 255   0
             299  215 -   0 255   0
             254  313 -   0 255   0
             239  343 -   0 255   0
             324  285 -   0 255   0
        "#,
    )?;

    Ok(())
}
