use test_engine::{
    from_main,
    refs::Weak,
    ui::{
        Anchor::{Right, Top},
        Button, Container, GREEN, Label, Setup, TURQUOISE, UI, UIImages, ViewData, ViewSubviews, YELLOW,
        view,
    },
    ui_test::check_colors,
    wait_for_next_frame,
};

#[view]
struct CellLayout {
    title: Weak<Container>,
    table: Weak<Container>,

    #[init]
    delete: Button,
    label:  Label,

    container: Container,
}

impl Setup for CellLayout {
    fn setup(mut self: Weak<Self>) {
        self.delete.place().t(100).l(400).size(50, 50);
        self.delete.set_image(UIImages::delete());

        self.label.place().l(50).t(100).h(200).anchor(Right, self.delete, 10);

        self.container.set_color(TURQUOISE);
        self.container.place().t(400).l(10).size(200, 160);

        self.title = self.container.add_view();
        self.table = self.container.add_view();

        self.title.place().lrt(10).h(50);
        self.title.set_color(GREEN);

        self.table.place().anchor(Top, self.title, 10).lrb(10);
        self.table.set_color(YELLOW);
    }
}

pub async fn test_cell_layout() -> anyhow::Result<()> {
    let view = UI::init_test_view::<CellLayout>().await;

    check_colors(
        r#"
              31  242 -  89 124 149
              57  238 - 255 255 255
              57  303 -  89 124 149
              87  342 -  89 124 149
             374  315 -  89 124 149
             374  255 - 255 255 255
             437  252 -  89 124 149
             460  157 -  89 124 149
             446  140 - 255 255 255
             421   69 -  89 124 149
             421  133 -  80 197 255
             394  133 -  89 124 149
             354  131 - 255 255 255
             354  131 - 255 255 255
             362   66 -  89 124 149
             405   71 -  89 124 149
             406  157 -  89 124 149
             356  231 - 255 255 255
             229  305 -  89 124 149
              88  348 -  89 124 149
              25  237 -  89 124 149
              64  144 - 255 255 255
              70   76 -  89 124 149
             310   17 -  89 124 149
             387   73 -  89 124 149
             425  133 -  30  63 107
             425  206 -  89 124 149
             378  321 -  89 124 149
             175  359 -  89 124 149
             481  126 -  89 124 149
        "#,
    )
    .await?;

    check_colors(
        r#"
             110  567 -  89 124 149
             110  567 -  89 124 149
             110  558 -   0 255 255
             110  538 - 255 255   0
             110  517 - 255 255   0
             110  472 - 255 255   0
             110  470 - 255 255   0
             110  469 -   0 255 255
             110  455 -   0 255   0
             110  427 -   0 255   0
             110  414 -   0 255   0
             110  399 -  89 124 149
             110  392 -  89 124 149
             128  374 -  89 124 149
             227  437 -  89 124 149
             227  436 -  89 124 149
             227  436 -  89 124 149
             227  436 -  89 124 149
             227  436 -  89 124 149
             184  436 -   0 255   0
             182  436 -   0 255   0
             183  436 -   0 255   0
             183  436 -   0 255   0
             191  436 -   0 255   0
             191  436 -   0 255   0
             191  436 -   0 255   0
             208  436 -   0 255 255
             230  521 -  89 124 149
             219  521 -  89 124 149
             216  521 -  89 124 149
             203  521 -   0 255 255
             196  521 - 255 255   0
             132  521 - 255 255   0
             132  521 - 255 255   0
             131  521 - 255 255   0
              39  514 - 255 255   0
              11  514 -   0 255 255
               8  517 -  89 124 149
               8  545 -  89 124 149
              16  545 -   0 255 255
              32  572 -  89 124 149
              60  357 -  89 124 149
              86  429 -   0 255   0
              79  460 -   0 255 255
              78  512 - 255 255   0
              81  561 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        view.title.place().clear().h(50).lrt(10);

        view.table.place().clear().lrb(10).anchor(Top, view.title, 10);
    })
    .await;

    wait_for_next_frame().await;

    check_colors(
        r#"
             110  567 -  89 124 149
             110  567 -  89 124 149
             110  558 -   0 255 255
             110  538 - 255 255   0
             110  517 - 255 255   0
             110  472 - 255 255   0
             110  470 - 255 255   0
             110  469 -   0 255 255
             110  455 -   0 255   0
             110  427 -   0 255   0
             110  414 -   0 255   0
             110  399 -  89 124 149
             110  392 -  89 124 149
             128  374 -  89 124 149
             227  437 -  89 124 149
             227  436 -  89 124 149
             227  436 -  89 124 149
             227  436 -  89 124 149
             227  436 -  89 124 149
             184  436 -   0 255   0
             182  436 -   0 255   0
             183  436 -   0 255   0
             183  436 -   0 255   0
             191  436 -   0 255   0
             191  436 -   0 255   0
             191  436 -   0 255   0
             208  436 -   0 255 255
             230  521 -  89 124 149
             219  521 -  89 124 149
             216  521 -  89 124 149
             203  521 -   0 255 255
             196  521 - 255 255   0
             132  521 - 255 255   0
             132  521 - 255 255   0
             131  521 - 255 255   0
              39  514 - 255 255   0
              11  514 -   0 255 255
               8  517 -  89 124 149
               8  545 -  89 124 149
              16  545 -   0 255 255
              32  572 -  89 124 149
              60  357 -  89 124 149
              86  429 -   0 255   0
              79  460 -   0 255 255
              78  512 - 255 255   0
              81  561 -  89 124 149
        "#,
    )
    .await?;

    Ok(())
}
