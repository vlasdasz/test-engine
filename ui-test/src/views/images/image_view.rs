use anyhow::Result;
use test_engine::{
    dispatch::from_main,
    refs::Weak,
    ui::{ImageMode, Setup, UI, UIManager, ViewData, ViewTouch, view},
    ui_test::helpers::check_colors,
};

#[view]
struct ImageView {
    #[init]
    image_view: test_engine::ui::ImageView,
}

impl Setup for ImageView {
    fn setup(mut self: Weak<Self>) {
        self.enable_touch();

        self.image_view.place().tl(100).size(280, 280);
        self.image_view.set_image("gradient.png");
    }
}

pub async fn test_image_view() -> Result<()> {
    let mut view = UI::init_test_view::<ImageView>().await;

    check_colors(
        r#"
              69  108 -  89 124 149
              82  108 -  89 124 149
             113  104 - 111 238  73
             127  103 - 105 226  72
             142  102 -  98 213  73
             166  102 -  88 191  79
             234  102 -  58 131 121
             319  104 -  22  55 188
             334  104 -  17  42 202
             357  104 -   9  22 222
             389  105 -  89 124 149
             406  114 -  89 124 149
             394  154 -  89 124 149
             370  172 -  67  67 176
             373  210 - 102 102 147
             369  253 - 140 140 113
             378  307 - 189 189  86
             376  342 - 221 221  79
             369  375 - 249 245  81
             351  395 -  89 124 149
             314  382 -  89 124 149
             283  368 - 233 171  60
             272  367 - 231 162  58
             257  367 - 229 148  54
             221  368 - 228 119  47
             143  375 - 230  65  37
             128  375 - 230  58  36
             117  362 - 218  52  36
             104  352 - 209  54  32
              98  308 -  89 124 149
              99  269 -  89 124 149
             107  239 - 127 128  39
             108  203 - 110 159  47
             108  185 - 105 175  52
             107  122 - 109 230  70
             136  182 -  89 124 149
             231  224 -  89 124 149
             153  238 -  89 124 149
              79  244 -  89 124 149
              53  258 -  89 124 149
             161  288 -  89 124 149
             348  290 -  89 124 149
             455  264 -  89 124 149
             467  165 -  89 124 149
             320   57 -  89 124 149
             214  101 -  67 149 107
             165  212 -  89 124 149
              45  241 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        view.image_view.place().clear().tl(100).size(400, 400);
    })
    .await;

    check_colors(
        r#"
              65  113 -  89 124 149
              89  103 -  89 124 149
             117  104 - 111 239  74
             160  103 -  98 213  73
             194  103 -  88 191  79
             241  102 -  73 162  96
             364  104 -  36  86 160
             371  104 -  34  81 165
             422  111 -  21  49 193
             465  111 -  12  23 219
             536  120 -  89 124 149
             545  128 -  89 124 149
             515  152 -  89 124 149
             489  187 -  57  57 187
             481  246 -  94  94 151
             488  381 - 179 179  89
             490  453 - 226 226  79
             486  497 - 251 246  82
             470  543 -  89 124 149
             456  530 -  89 124 149
             424  487 - 240 208  70
             360  479 - 230 170  60
             270  478 - 224 117  47
             178  484 - 225  70  38
             135  486 - 226  56  36
              88  482 -  89 124 149
              79  467 -  89 124 149
              97  444 -  89 124 149
             127  431 -  89 124 149
             131  387 -  89 124 149
             124  283 - 121 137  43
             115  229 - 106 171  51
             115  191 - 102 194  58
             108  148 - 106 221  66
              95  255 -  89 124 149
             102  386 - 169  80  30
             283  337 -  89 124 149
             371  272 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        UIManager::enable_debug_frames();
        view.image_view.place().clear().tl(140).size(280, 200);
        view.image_view.set_image("cat.png");
    })
    .await;

    check_colors(
        r#"
              92  293 -  89 124 149
             110  288 -  89 124 149
             121  286 -  89 124 149
             136  284 -  89 124 149
             153  284 - 224 162 165
             166  283 - 238 207 202
             230  282 - 218 183 161
             310  278 - 196 167 149
             328  278 - 202 170 149
             357  277 - 167 135 114
             391  276 - 163 131 110
             418  272 -   0 255 255
             430  269 -  89 124 149
             451  259 -  89 124 149
             471  164 -  89 124 149
             428   84 -  89 124 149
             381   71 -  89 124 149
             330  122 -  89 124 149
             331  134 -  89 124 149
             329  156 - 225 181 182
             323  176 - 222 176 176
             315  208 - 188 160 136
             304  249 - 179 144 116
             294  291 - 207 175 152
             292  322 - 209 174 152
             291  379 -  89 124 149
             253  382 -  89 124 149
             181  365 -  89 124 149
             180  363 -  89 124 149
             181  340 -  89 124 149
             182  329 - 225 191 182
             184  303 - 237 203 194
             184  272 - 236 208 197
             181  237 - 241 214 207
             179  194 - 230 190 191
             180  172 - 234 194 195
             175  137 -  89 124 149
             163  121 -  89 124 149
             106  121 -  89 124 149
             101  167 -  89 124 149
             185  196 - 228 188 189
             270  204 - 211 184 163
             410  204 - 203 153 152
             476  215 -  89 124 149
             453  261 -  89 124 149
             228  285 - 210 178 155
              60  292 -  89 124 149
             174  385 -  89 124 149
             310  391 -  89 124 149
             389  333 - 182 150 127
             528  264 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        view.image_view.mode = ImageMode::AspectFit;
        view.image_view.place().clear().tl(140).size(280, 200);
    })
    .await;

    check_colors(
        r#"
             124  269 -  89 124 149
             126  270 -  89 124 149
             151  267 -  89 124 149
             181  263 -  89 124 149
             239  277 - 230 200 189
             273  281 - 205 170 148
             326  275 - 169 137 116
             412  269 -  89 124 149
             465  259 -  89 124 149
             476  233 -  89 124 149
             435  210 -  89 124 149
             407  201 -  89 124 149
             336  194 - 155 113  91
             297  195 - 181 155 132
             228  197 - 230 190 191
             147  199 -  89 124 149
              95  185 -  89 124 149
             148  169 -  89 124 149
             217  175 - 232 196 198
             318  175 - 212 162 161
             458  175 -  89 124 149
             500  141 -  89 124 149
             428  310 -  89 124 149
             397  327 -  89 124 149
             207  310 -  89 124 149
               6  312 -  89 124 149
             272  414 -  89 124 149
             269  363 -  89 124 149
             223  255 - 243 212 207
             219  102 -  89 124 149
             220   71 -  89 124 149
             278  100 -  89 124 149
             314  118 -  89 124 149
             326  282 - 159 128 107
             312  360 -  89 124 149
             496  341 -  89 124 149
             468  253 -  89 124 149
             307  215 - 170 142 120
              53  223 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        view.image_view.place().clear().tl(140).size(100, 400);
    })
    .await;

    check_colors(
        r#"
              95  315 -  89 124 149
             118  300 -  89 124 149
             150  293 - 229 189 190
             193  294 - 225 179 181
             233  296 - 209 159 158
             272  305 -  89 124 149
             273  343 -  89 124 149
             259  361 -  89 124 149
             205  366 - 198 168 144
              93  388 -  89 124 149
             161  422 -  89 124 149
             238  426 -   0 255 255
             181  562 -  89 124 149
             185  540 -  89 124 149
             183  509 -  89 124 149
             187  468 -  89 124 149
             188  417 -  89 124 149
             189  358 - 204 158 142
             187  284 - 224 182 183
             173  191 -  89 124 149
             161  135 -  89 124 149
             154   84 -  89 124 149
             206  125 -  89 124 149
             212  185 -  89 124 149
             203  246 -  89 124 149
             208  285 - 223 177 179
             224  352 - 174 146 124
             206  385 - 188 156 135
             179  438 -  89 124 149
             137  469 -  89 124 149
              92  448 -  89 124 149
             132  377 -  89 124 149
             224  327 - 136  80  57
             284  304 -  89 124 149
             255  265 -  89 124 149
              68  310 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        view.image_view.mode = ImageMode::AspectFill;
        view.image_view.place().clear().tl(140).size(280, 200);
    })
    .await;

    check_colors(
        r#"
              91  424 -  89 124 149
             165  403 - 221 159 160
             292  393 - 206 171 151
             367  378 - 157 129 105
             425  350 -  89 124 149
             491  316 -  89 124 149
             468  300 -  89 124 149
             348  277 - 196 161 139
             299  281 - 196 158 135
             201  273 - 237 207 197
             135  273 -  89 124 149
             117  258 -  89 124 149
              64  228 -  89 124 149
             179  200 - 230 190 190
             355  197 - 158 122 100
             478  187 -  89 124 149
             505  149 -  89 124 149
             460   74 -  89 124 149
             367   84 - 220 172 172
             245   79 - 230 190 190
              77   70 -  89 124 149
              64   63 -  89 124 149
             184   32 -  89 124 149
             237   26 -  89 124 149
             356   67 - 220 174 174
             354  234 - 183 151 126
             321  336 - 203 171 150
             298  413 - 204 172 151
             298  485 -  89 124 149
        "#,
    )
    .await?;

    from_main(move || {
        view.image_view.place().clear().tl(140).size(100, 400);
    })
    .await;

    check_colors(
        r#"
              23  163 -  89 124 149
              61  160 - 235 198 205
             102  166 - 231 192 197
             190  178 - 223 182 180
             228  182 - 224 178 180
             305  193 - 211 161 160
             326  202 - 213 163 164
             355  229 -  89 124 149
             344  242 -  89 124 149
             259  259 - 185 149 127
             142  266 - 220 192 178
              53  286 - 231 191 192
              43  299 -  89 124 149
              31  317 -  89 124 149
              81  370 - 244 221 213
             146  361 - 227 191 177
             250  370 - 200 166 141
             330  389 - 199 147 149
             369  419 -  89 124 149
             320  441 - 154 127 106
             155  467 - 209 174 154
              68  470 - 230 176 176
              35  481 -  89 124 149
              33  511 -  89 124 149
              45  541 -  89 124 149
             159  566 -  89 124 149
             202  546 -  89 124 149
             207  482 - 208 173 153
             191  368 - 186 140 116
             187  261 - 204 180 156
             202  208 - 225 179 181
             223   93 -  89 124 149
             332  145 -  89 124 149
        "#,
    )
    .await?;

    from_main(|| UIManager::disable_debug_frames()).await;

    Ok(())
}
